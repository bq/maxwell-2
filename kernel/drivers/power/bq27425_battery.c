/*
 * BQ27425 battery driver
 *
 * This package is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License version 2 as
 * published by the Free Software Foundation.
 *
 * THIS PACKAGE IS PROVIDED ``AS IS'' AND WITHOUT ANY EXPRESS OR
 * IMPLIED WARRANTIES, INCLUDING, WITHOUT LIMITATION, THE IMPLIED
 * WARRANTIES OF MERCHANTIBILITY AND FITNESS FOR A PARTICULAR PURPOSE.
 *
 */
#include <linux/module.h>
#include <linux/param.h>
#include <linux/jiffies.h>
#include <linux/workqueue.h>
#include <linux/delay.h>
#include <linux/platform_device.h>
#include <linux/power_supply.h>
#include <linux/idr.h>
#include <linux/i2c.h>
#include <linux/slab.h>
#include <asm/unaligned.h>
#include <mach/gpio.h>
#include <linux/proc_fs.h>
#include <asm/uaccess.h>
#include <mach/board.h>
#include <linux/irq.h>
#include <linux/interrupt.h>
#include <linux/power/bq27425_battery.h>


#define DRIVER_VERSION			"1.1.0"
#define BQ27425_REG_CONTROL		0x00
#define BQ27425_REG_TEMP			0x02
#define BQ27425_REG_VOL			0x04
#define BQ27425_REG_FLAGS			0x06
#define BQ27425_REG_NOMINAL_CAP		0x08
#define BQ27425_REG_FULL_CAP			0x0A
#define BQ27425_REG_REMAINING_CAP		0x0C
#define BQ27425_REG_FULL_CHARGE_CAP	0x0E
#define BQ27425_REG_AVERAGE_CURRENT	0x10
#define BQ27425_REG_DEBUG1				0x16
#define BQ27425_REG_AVERAGE_POWER		0x18
#define BQ27425_REG_STATE_OF_CHARGER	0x1C
#define BQ27425_REG_INT_TMP				0x1E
#define BQ27425_REG_STATE_OF_HEALTH	0x20
#define BQ27425_REG_DEBUG2				0x2C
#define BQ27425_REG_DEBUG3				0x32
#define BQ27425_REG_OPCONFIG				0x3A
#define BQ27425_REG_DESIGN_CAP			0x3C

#define BQ27425_FLAG_DSC		BIT(0)
#define BQ27425_FLAG_SOCF		BIT(1) /* State-of-Charge threshold final */
#define BQ27425_FLAG_SOC1		BIT(2) /* State-of-Charge threshold 1 */
#define BQ27425_FLAG_ITPOR		BIT(5)
#define BQ27425_FLAG_FC		BIT(9)
#define BQ27425_FLAG_OTC		BIT(15)

#define BQ27425_CONTROL_STATUS_SS		BIT(13)

#define BQ27425_SPEED 			100 * 1000

/*M-MT:define bq27425 mode*/
#define BQ27425_NORMAL_MODE 		0		//when in normal mode ,iic addr = 0x55
#define BQ27425_ROM_MODE 			1		//when in normal mode ,iic addr = 0x0b

int  g_bq27425_mode = BQ27425_NORMAL_MODE;
/*M-MT:define bq27425 mode end*/


int  virtual_battery_enable = 0;
extern int dwc_vbus_status(void);

struct bq27425_platform_data *g_pdata;
struct i2c_client *g_client;

#if 1
#define DBG(x...) printk(KERN_INFO x)
#else
#define DBG(x...) do { } while (0)
#endif

#define INVILD	-1

//以下ROM数据来自DFFS文件
static u8 flash_init_data[][7] =
{
	/*==========================
	Write Config Byte: Address - 0x4000
	W: 16 00 09 00 40 00 00//后5位
	W: 16 64 49 00//后2位
	============================*/
	{0x09, 0x00, 0x40, 0x00, 0x00,0x49, 0x00},
	/*==========================
	Write Config Byte: Address - 0x4001
	W: 16 00 09 01 40 00 66
	W: 16 64 B0 00
	============================*/
	{0x09, 0x01, 0x40, 0x00, 0x66,0xB0, 0x00},
	/*==========================
	Write Config Byte: Address - 0x4002
	W: 16 00 09 02 40 00 00
	W: 16 64 4B 00
	============================*/
	{0x09, 0x02, 0x40, 0x00, 0x00,0x4B, 0x00},
	/*==========================
	Write Config Byte: Address - 0x4003
	W: 16 00 09 03 40 00 66
	W: 16 64 B2 00
	============================*/
	{0x09, 0x03, 0x40, 0x00, 0x66,0xB2, 0x00},
	/*==========================
	Write Config Byte: Address - 0x4004
	W: 16 00 09 04 40 00 00
	W: 16 64 4D 00
	============================*/
	{0x09, 0x04, 0x40, 0x00, 0x00,0x4D, 0x00},
	/*==========================
	Write Config Byte: Address - 0x4005
	W: 16 00 09 05 40 00 63
	W: 16 64 B1 00
	============================*/
	{0x09, 0x05, 0x40, 0x00, 0x63,0xB1, 0x00},
	/*==========================
	Write Config Byte: Address - 0x4006
	W: 16 00 09 06 40 00 00
	W: 16 64 4F 00
	============================*/
	{0x09, 0x06, 0x40, 0x00, 0x00,0x4F, 0x00},
	/*==========================
	Write Config Byte: Address - 0x4007
	W: 16 00 09 07 40 00 6B
	W: 16 64 BB 00
	============================*/
	{0x09, 0x07, 0x40, 0x00, 0x6B,0xBB, 0x00},
	/*==========================
	Write Config Byte: Address - 0x4008
	W: 16 00 09 08 40 00 00
	W: 16 64 51 00
	============================*/
	{0x09, 0x08, 0x40, 0x00, 0x00,0x51, 0x00},
	/*==========================
	Write Config Byte: Address - 0x4009
	W: 16 00 09 09 40 00 48
	W: 16 64 9A 00
	============================*/
	{0x09, 0x09, 0x40, 0x00, 0x48,0x9A, 0x00},
	/*==========================
	Write Config Byte: Address - 0x400a
	W: 16 00 09 0A 40 00 00
	W: 16 64 53 00
	============================*/
	{0x09, 0x0A, 0x40, 0x00, 0x00,0x53, 0x00},
	/*==========================
	Write Config Byte: Address - 0x400b
	W: 16 00 09 0B 40 00 3B
	W: 16 64 8F 00
	============================*/
	{0x09, 0x0B, 0x40, 0x00, 0x3B,0x8F, 0x00},
	/*==========================
	Write Config Byte: Address - 0x400c
	W: 16 00 09 0C 40 00 00
	W: 16 64 55 00
	============================*/
	{0x09, 0x0C, 0x40, 0x00, 0x00,0x55, 0x00},
	/*==========================
	Write Config Byte: Address - 0x400d
	W: 16 00 09 0D 40 00 3E
	W: 16 64 94 00
	============================*/
	{0x09, 0x0D, 0x40, 0x00, 0x3E,0x94, 0x00},
	/*==========================
	Write Config Byte: Address - 0x400e
	W: 16 00 09 0E 40 00 00
	W: 16 64 57 00
	============================*/
	{0x09, 0x0E, 0x40, 0x00, 0x00,0x57, 0x00},
	/*==========================
	Write Config Byte: Address - 0x400f
	W: 16 00 09 0F 40 00 3F
	W: 16 64 97 00
	============================*/
	{0x09, 0x0F, 0x40, 0x00, 0x3F,0x97, 0x00},


	/*==========================
	Write Config Byte: Address - 0x4010
	W: 16 00 09 10 40 00 00
	W: 16 64 59 00
	============================*/
	{0x09, 0x10, 0x40, 0x00, 0x00,0x59, 0x00},
	/*==========================
	Write Config Byte: Address - 0x4011
	W: 16 00 09 11 40 00 35
	W: 16 64 8F 00
	============================*/
	{0x09, 0x11, 0x40, 0x00, 0x35,0x8F, 0x00},
	/*==========================
	Write Config Byte: Address - 0x4012
	W: 16 00 09 12 40 00 00
	W: 16 64 5B 00
	============================*/
	{0x09, 0x12, 0x40, 0x00, 0x00,0x5B, 0x00},
	/*==========================
	Write Config Byte: Address - 0x4013
	W: 16 00 09 13 40 00 2F
	W: 16 64 8B 00
	============================*/
	{0x09, 0x13, 0x40, 0x00, 0x2F,0x8B, 0x00},
	/*==========================
	Write Config Byte: Address - 0x4014
	W: 16 00 09 14 40 00 00
	W: 16 64 5D 00
	============================*/
	{0x09, 0x14, 0x40, 0x00, 0x00,0x5D, 0x00},
	/*==========================
	Write Config Byte: Address - 0x4015
	W: 16 00 09 15 40 00 3C
	W: 16 64 9A 00
	============================*/
	{0x09, 0x15, 0x40, 0x00, 0x3C,0x9A, 0x00},
	/*==========================
	Write Config Byte: Address - 0x4016
	W: 16 00 09 16 40 00 00
	W: 16 64 5F 00
	============================*/
	{0x09, 0x16, 0x40, 0x00, 0x00,0x5F, 0x00},
	/*==========================
	Write Config Byte: Address - 0x4017
	W: 16 00 09 17 40 00 46
	W: 16 64 A6 00
	============================*/
	{0x09, 0x17, 0x40, 0x00, 0x46,0xA6, 0x00},
	/*==========================
	Write Config Byte: Address - 0x4018
	W: 16 00 09 18 40 00 00
	W: 16 64 61 00
	============================*/
	{0x09, 0x18, 0x40, 0x00, 0x00,0x61, 0x00},
	/*==========================
	Write Config Byte: Address - 0x4019
	W: 16 00 09 19 40 00 8C
	W: 16 64 EE 00
	============================*/
	{0x09, 0x19, 0x40, 0x00, 0x8C,0xEE, 0x00},
	/*==========================
	Write Config Byte: Address - 0x401a
	W: 16 00 09 1A 40 00 01
	W: 16 64 64 00
	============================*/
	{0x09, 0x1A, 0x40, 0x00, 0x01,0x64, 0x00},
	/*==========================
	Write Config Byte: Address - 0x401b
	W: 16 00 09 1B 40 00 71
	W: 16 64 D5 00
	============================*/
	{0x09, 0x1B, 0x40, 0x00, 0x71,0xD5, 0x00},
	/*==========================
	Write Config Byte: Address - 0x401c
	W: 16 00 09 1C 40 00 02
	W: 16 64 67 00
	============================*/
	{0x09, 0x1C, 0x40, 0x00, 0x02,0x67, 0x00},
	/*==========================
	Write Config Byte: Address - 0x401d
	W: 16 00 09 1D 40 00 4C
	W: 16 64 B2 00
	============================*/
	{0x09, 0x1D, 0x40, 0x00, 0x4C,0xB2, 0x00},
	/*==========================
	Write Config Byte: Address - 0x401e
	W: 16 00 09 1E 40 00 50
	W: 16 64 B7 00
	============================*/
	{0x09, 0x1E, 0x40, 0x00, 0x50,0xB7, 0x00},
	/*==========================
	Write Config Byte: Address - 0x401f
	W: 16 00 09 1F 40 00 00
	W: 16 64 68 00
	============================*/
	{0x09, 0x1F, 0x40, 0x00, 0x00,0x68, 0x00},

	/*==========================
	Write Config Byte: Address - 0x4020
	W: 16 00 09 20 40 00 00
	W: 16 64 69 00
	============================*/
	{0x09, 0x20, 0x40, 0x00, 0x00,0x69, 0x00},
	/*==========================
	Write Config Byte: Address - 0x4021
	W: 16 00 09 21 40 00 01
	W: 16 64 6B 00
	============================*/
	{0x09, 0x21, 0x40, 0x00, 0x01,0x6B, 0x00},
	/*==========================
	Write Config Byte: Address - 0x4022
	W: 16 00 09 22 40 00 00
	W: 16 64 6B 00
	============================*/
	{0x09, 0x22, 0x40, 0x00, 0x00,0x6B, 0x00},
	/*==========================
	Write Config Byte: Address - 0x4023
	W: 16 00 09 23 40 00 C8
	W: 16 64 34 01
	============================*/
	{0x09, 0x23, 0x40, 0x00, 0xC8,0x34, 0x01},
	/*==========================
	Write Config Byte: Address - 0x402a
	W: 16 00 09 2A 40 00 DC
	W: 16 64 4F 01
	============================*/
	{0x09, 0x2A, 0x40, 0x00, 0xDC,0x4F, 0x01},
	/*==========================
	Write Config Byte: Address - 0x402c
	W: 16 00 09 2C 40 00 F3
	W: 16 64 68 01
	============================*/
	{0x09, 0x2C, 0x40, 0x00, 0xF3,0x68, 0x01},
	/*==========================
	Write Config Byte: Address - 0x402d
	W: 16 00 09 2D 40 00 3A
	W: 16 64 B0 00
	============================*/
	{0x09, 0x2D, 0x40, 0x00, 0x3A,0xB0, 0x00},
	/*==========================
	Write Config Byte: Address - 0x402e
	W: 16 00 09 2E 40 00 36
	W: 16 64 AD 00
	============================*/
	{0x09, 0x2E, 0x40, 0x00, 0x36,0xAD, 0x00},
	/*==========================
	Write Config Byte: Address - 0x402f
	W: 16 00 09 2F 40 00 FD
	W: 16 64 75 01
	============================*/
	{0x09, 0x2F, 0x40, 0x00, 0xFD,0x75, 0x01},

	/*==========================
	Write Config Byte: Address - 0x4030
	W: 16 00 09 30 40 00 91
	W: 16 64 0A 01
	============================*/
	{0x09, 0x30, 0x40, 0x00, 0x91,0x0A, 0x01},
	/*==========================
	Write Config Byte: Address - 0x4031
	W: 16 00 09 31 40 00 00
	W: 16 64 7A 00
	============================*/
	{0x09, 0x31, 0x40, 0x00, 0x00,0x7A, 0x00},
	/*==========================
	Write Config Byte: Address - 0x4032
	W: 16 00 09 32 40 00 25
	W: 16 64 A0 00
	============================*/
	{0x09, 0x32, 0x40, 0x00, 0x25,0xA0, 0x00},
	/*==========================
	Write Config Byte: Address - 0x4033
	W: 16 00 09 33 40 00 30
	W: 16 64 AC 00
	============================*/
	{0x09, 0x33, 0x40, 0x00, 0x30,0xAC, 0x00},	
	/*==========================
	Write Config Byte: Address - 0x4034
	W: 16 00 09 34 40 00 40
	W: 16 64 BD 00
	============================*/
	{0x09, 0x34, 0x40, 0x00, 0x40,0xBD, 0x00},
	/*==========================
	Write Config Byte: Address - 0x4035
	W: 16 00 09 35 40 00 00
	W: 16 64 7E 00
	============================*/
	{0x09, 0x35, 0x40, 0x00, 0x00,0x7E, 0x00},
	/*==========================
	Write Config Byte: Address - 0x4036
	W: 16 00 09 36 40 00 04
	W: 16 64 83 00
	============================*/
	{0x09, 0x36, 0x40, 0x00, 0x04,0x83, 0x00},
	/*==========================
	Write Config Byte: Address - 0x4037
	W: 16 00 09 37 40 00 00
	W: 16 64 80 00
	============================*/
	{0x09, 0x37, 0x40, 0x00, 0x00,0x80, 0x00},
	/*==========================
	Write Config Byte: Address - 0x4038
	W: 16 00 09 38 40 00 00
	W: 16 64 81 00
	============================*/
	{0x09, 0x38, 0x40, 0x00, 0x00,0x81, 0x00},
	/*==========================
	Write Config Byte: Address - 0x4039
	W: 16 00 09 39 40 00 89
	W: 16 64 0B 01
	============================*/
	{0x09, 0x39, 0x40, 0x00, 0x89,0x0B, 0x01},
	/*==========================
	Write Config Byte: Address - 0x403a
	W: 16 00 09 3A 40 00 F8
	W: 16 64 7B 01
	============================*/
	{0x09, 0x3A, 0x40, 0x00, 0xF8,0x7B, 0x01},
	/*==========================
	Write Config Byte: Address - 0x403b
	W: 16 00 09 3B 40 00 81
	W: 16 64 05 01
	============================*/
	{0x09, 0x3B, 0x40, 0x00, 0x81,0x05, 0x01},
	/*==========================
	Write Config Byte: Address - 0x403c
	W: 16 00 09 3C 40 00 0E
	W: 16 64 93 00
	============================*/
	{0x09, 0x3C, 0x40, 0x00, 0x0E,0x93, 0x00},
	/*==========================
	Write Config Byte: Address - 0x403d
	W: 16 00 09 3D 40 00 DB
	W: 16 64 61 01
	============================*/
	{0x09, 0x3D, 0x40, 0x00, 0xDB,0x61, 0x01},
	/*==========================
	Write Config Byte: Address - 0x403e
	W: 16 00 09 3E 40 00 0E
	W: 16 64 95 00
	============================*/
	{0x09, 0x3E, 0x40, 0x00, 0x0E,0x95, 0x00},
	/*==========================
	Write Config Byte: Address - 0x403f
	W: 16 00 09 3F 40 00 A8
	W: 16 64 30 01
	============================*/
	{0x09, 0x3F, 0x40, 0x00, 0xA8,0x30, 0x01},

	/*==========================
	Write Config Byte: Address - 0x4040
	W: 16 00 09 40 40 00 10
	W: 16 64 99 00
	============================*/
	{0x09, 0x40, 0x40, 0x00, 0x10,0x99, 0x00},
	/*==========================
	Write Config Byte: Address - 0x4041
	W: 16 00 09 41 40 00 CC
	W: 16 64 56 01
	============================*/
	{0x09, 0x41, 0x40, 0x00, 0xCC,0x56, 0x01},
	/*==========================
	Write Config Byte: Address - 0x4042
	W: 16 00 09 42 40 00 3E
	W: 16 64 C9 00
	============================*/
	{0x09, 0x42, 0x40, 0x00, 0x3E,0xC9, 0x00},
	/*==========================
	Write Config Byte: Address - 0x4043
	W: 16 00 09 43 40 00 26
	W: 16 64 B2 00
	============================*/
	{0x09, 0x43, 0x40, 0x00, 0x26,0xB2, 0x00},
	/*==========================
	Write Config Byte: Address - 0x4044
	W: 16 00 09 44 40 00 05
	W: 16 64 92 00
	============================*/
	{0x09, 0x44, 0x40, 0x00, 0x05,0x92, 0x00},
	/*==========================
	Write Config Byte: Address - 0x4045
	W: 16 00 09 45 40 00 3C
	W: 16 64 CA 00
	============================*/
	{0x09, 0x45, 0x40, 0x00, 0x3C,0xCA, 0x00},
	/*==========================
	Write Config Byte: Address - 0x4046
	W: 16 00 09 46 40 00 0D
	W: 16 64 9C 00
	============================*/
	{0x09, 0x46, 0x40, 0x00, 0x0D,0x9C, 0x00},
	/*==========================
	Write Config Byte: Address - 0x4047
	W: 16 00 09 47 40 00 48
	W: 16 64 D8 00
	============================*/
	{0x09, 0x47, 0x40, 0x00, 0x48,0xD8, 0x00},
	/*==========================
	Write Config Byte: Address - 0x4048
	W: 16 00 09 48 40 00 00
	W: 16 64 91 00
	============================*/
	{0x09, 0x48, 0x40, 0x00, 0x00,0x91, 0x00},
	/*==========================
	Write Config Byte: Address - 0x4049
	W: 16 00 09 49 40 00 C8
	W: 16 64 5A 01
	============================*/
	{0x09, 0x49, 0x40, 0x00, 0xC8,0x5A, 0x01},
	/*==========================
	Write Config Byte: Address - 0x404a
	W: 16 00 09 4A 40 00 00
	W: 16 64 93 00
	============================*/
	{0x09, 0x4A, 0x40, 0x00, 0x00,0x93, 0x00},
	/*==========================
	Write Config Byte: Address - 0x404b
	W: 16 00 09 4B 40 00 32
	W: 16 64 C6 00
	============================*/
	{0x09, 0x4B, 0x40, 0x00, 0x32,0xC6, 0x00},
	/*==========================
	Write Config Byte: Address - 0x404c
	W: 16 00 09 4C 40 00 00
	W: 16 64 95 00
	============================*/
	{0x09, 0x4C, 0x40, 0x00, 0x00,0x95, 0x00},
	/*==========================
	Write Config Byte: Address - 0x404d
	W: 16 00 09 4D 40 00 14
	W: 16 64 AA 00
	============================*/
	{0x09, 0x4D, 0x40, 0x00, 0x14,0xAA, 0x00},
	/*==========================
	Write Config Byte: Address - 0x404e
	W: 16 00 09 4E 40 00 03
	W: 16 64 9A 00
	============================*/
	{0x09, 0x4E, 0x40, 0x00, 0x03,0x9A, 0x00},
	/*==========================
	Write Config Byte: Address - 0x404f
	W: 16 00 09 4F 40 00 E8
	W: 16 64 80 01
	============================*/
	{0x09, 0x4F, 0x40, 0x00, 0xE8,0x80, 0x01},

	/*==========================
	Write Config Byte: Address - 0x4050
	W: 16 00 09 50 40 00 00
	W: 16 64 99 00
	============================*/
	{0x09, 0x50, 0x40, 0x00, 0x00,0x99, 0x00},
	/*==========================
	Write Config Byte: Address - 0x4051
	W: 16 00 09 51 40 00 01
	W: 16 64 9B 00
	============================*/
	{0x09, 0x51, 0x40, 0x00, 0x01,0x9B, 0x00},
	/*==========================
	Write Config Byte: Address - 0x4052
	W: 16 00 09 52 40 00 00
	W: 16 64 9B 00
	============================*/
	{0x09, 0x52, 0x40, 0x00, 0x00,0x9B, 0x00},	
	/*==========================
	Write Config Byte: Address - 0x4053
	W: 16 00 09 53 40 00 C8
	W: 16 64 64 01
	============================*/
	{0x09, 0x53, 0x40, 0x00, 0xC8,0x64, 0x01},	
	/*==========================
	Write Config Byte: Address - 0x4054
	W: 16 00 09 54 40 00 10
	W: 16 64 AD 00
	============================*/
	{0x09, 0x54, 0x40, 0x00, 0x10,0xAD, 0x00},
	/*==========================
	Write Config Byte: Address - 0x4055
	W: 16 00 09 55 40 00 04
	W: 16 64 A2 00
	============================*/
	{0x09, 0x55, 0x40, 0x00, 0x04,0xA2, 0x00},
	/*==========================
	Write Config Byte: Address - 0x4056
	W: 16 00 09 56 40 00 00
	W: 16 64 9F 00
	============================*/
	{0x09, 0x56, 0x40, 0x00, 0x00,0x9F, 0x00},
	/*==========================
	Write Config Byte: Address - 0x4057
	W: 16 00 09 57 40 00 0A
	W: 16 64 AA 00
	============================*/
	{0x09, 0x57, 0x40, 0x00, 0x0A,0xAA, 0x00},
	/*==========================
	Write Config Byte: Address - 0x4058
	W: 16 00 09 58 40 00 10
	W: 16 64 B1 00
	============================*/
	{0x09, 0x58, 0x40, 0x00, 0x10,0xB1, 0x00},
	/*==========================
	Write Config Byte: Address - 0x4059
	W: 16 00 09 59 40 00 5E
	W: 16 64 00 01
	============================*/
	{0x09, 0x59, 0x40, 0x00, 0x5E,0x00, 0x01},
	/*==========================
	Write Config Byte: Address - 0x405a
	W: 16 00 09 5A 40 00 B3
	W: 16 64 56 01
	============================*/
	{0x09, 0x5A, 0x40, 0x00, 0xB3,0x56, 0x01},
	/*==========================
	Write Config Byte: Address - 0x405b
	W: 16 00 09 5B 40 00 B3
	W: 16 64 57 01
	============================*/
	{0x09, 0x5B, 0x40, 0x00, 0xB3,0x57, 0x01},
	/*==========================
	Write Config Byte: Address - 0x405c
	W: 16 00 09 5C 40 00 75
	W: 16 64 1A 01
	============================*/
	{0x09, 0x5C, 0x40, 0x00, 0x75,0x1A, 0x01},
	/*==========================
	Write Config Byte: Address - 0x405d
	W: 16 00 09 5D 40 00 4E
	W: 16 64 F4 00
	============================*/
	{0x09, 0x5D, 0x40, 0x00, 0x4E,0xF4, 0x00},
	/*==========================
	Write Config Byte: Address - 0x405e
	W: 16 00 09 5E 40 00 0B
	W: 16 64 B2 00
	============================*/
	{0x09, 0x5E, 0x40, 0x00, 0x0B,0xB2, 0x00},
	/*==========================
	Write Config Byte: Address - 0x405f
	W: 16 00 09 5F 40 00 91
	W: 16 64 39 01
	============================*/
	{0x09, 0x5F, 0x40, 0x00, 0x91,0x39, 0x01},

	/*==========================
	Write Config Byte: Address - 0x4060
	W: 16 00 09 60 40 00 01
	W: 16 64 AA 00
	============================*/
	{0x09, 0x60, 0x40, 0x00, 0x01,0xAA, 0x00},
	/*==========================
	Write Config Byte: Address - 0x4061
	W: 16 00 09 61 40 00 28
	W: 16 64 D2 00
	============================*/
	{0x09, 0x61, 0x40, 0x00, 0x28,0xD2, 0x00},
	/*==========================
	Write Config Byte: Address - 0x4062
	W: 16 00 09 62 40 00 10
	W: 16 64 BB 00
	============================*/
	{0x09, 0x62, 0x40, 0x00, 0x10,0xBB, 0x00},	
	/*==========================
	Write Config Byte: Address - 0x4063
	W: 16 00 09 63 40 00 63
	W: 16 64 0F 01
	============================*/
	{0x09, 0x63, 0x40, 0x00, 0x63,0x0F, 0x01},	
	/*==========================
	Write Config Byte: Address - 0x4064
	W: 16 00 09 64 40 00 E5
	W: 16 64 92 01
	============================*/
	{0x09, 0x64, 0x40, 0x00, 0xE5,0x92, 0x01},
	/*==========================
	Write Config Byte: Address - 0x4065
	W: 16 00 09 65 40 00 E5
	W: 16 64 93 01
	============================*/
	{0x09, 0x65, 0x40, 0x00, 0xE5,0x93, 0x01},
	/*==========================
	Write Config Byte: Address - 0x4066
	W: 16 00 09 66 40 00 E8
	W: 16 64 97 01
	============================*/	
	{0x09, 0x66, 0x40, 0x00, 0xE8,0x97, 0x01},
	/*==========================
	Write Config Byte: Address - 0x4067
	W: 16 00 09 67 40 00 E7
	W: 16 64 97 01
	============================*/
	{0x09, 0x67, 0x40, 0x00, 0xE7,0x97, 0x01},
	/*==========================
	Write Config Byte: Address - 0x4068
	W: 16 00 09 68 40 00 EA
	W: 16 64 9B 01
	============================*/
	{0x09, 0x68, 0x40, 0x00, 0xEA,0x9B, 0x01},
	/*==========================
	Write Config Byte: Address - 0x4069
	W: 16 00 09 69 40 00 EA
	W: 16 64 9C 01
	============================*/	
	{0x09, 0x69, 0x40, 0x00, 0xEA,0x9C, 0x01},
	/*==========================
	Write Config Byte: Address - 0x406a
	W: 16 00 09 6A 40 00 EC
	W: 16 64 9F 01
	============================*/
	{0x09, 0x6A, 0x40, 0x00, 0xEC,0x9F, 0x01},
	/*==========================
	Write Config Byte: Address - 0x406b
	W: 16 00 09 6B 40 00 EC
	W: 16 64 A0 01
	============================*/
	{0x09, 0x6B, 0x40, 0x00, 0xEC,0xA0, 0x01},
	/*==========================
	Write Config Byte: Address - 0x406c
	W: 16 00 09 6C 40 00 EE
	W: 16 64 A3 01
	============================*/
	{0x09, 0x6C, 0x40, 0x00, 0xEE,0xA3, 0x01},
	/*==========================
	Write Config Byte: Address - 0x406d
	W: 16 00 09 6D 40 00 EE
	W: 16 64 A4 01
	============================*/
	{0x09, 0x6D, 0x40, 0x00, 0xEE,0xA4, 0x01},
	/*==========================
	Write Config Byte: Address - 0x406e
	W: 16 00 09 6E 40 00 F0
	W: 16 64 A7 01
	============================*/
	{0x09, 0x6E, 0x40, 0x00, 0xF0,0xA7, 0x01},
	/*==========================
	Write Config Byte: Address - 0x406f
	W: 16 00 09 6F 40 00 F1
	W: 16 64 A9 01
	============================*/
	{0x09, 0x6F, 0x40, 0x00, 0xF1,0xA9, 0x01},

	/*==========================
	Write Config Byte: Address - 0x4070
	W: 16 00 09 70 40 00 F1
	W: 16 64 AA 01
	============================*/
	{0x09, 0x70, 0x40, 0x00, 0xF1,0xAA, 0x01},
	/*==========================
	Write Config Byte: Address - 0x4071
	W: 16 00 09 71 40 00 EF
	W: 16 64 A9 01
	============================*/
	{0x09, 0x71, 0x40, 0x00, 0xEF,0xA9, 0x01},
	/*==========================
	Write Config Byte: Address - 0x4072
	W: 16 00 09 72 40 00 EB
	W: 16 64 A6 01
	============================*/
	{0x09, 0x72, 0x40, 0x00, 0xEB,0xA6, 0x01},	
	/*==========================
	Write Config Byte: Address - 0x4073
	W: 16 00 09 73 40 00 EC
	W: 16 64 A8 01
	============================*/
	{0x09, 0x73, 0x40, 0x00, 0xEC,0xA8, 0x01},	
	/*==========================
	Write Config Byte: Address - 0x4074
	W: 16 00 09 74 40 00 ED
	W: 16 64 AA 01
	============================*/
	{0x09, 0x74, 0x40, 0x00, 0xED,0xAA, 0x01},
	/*==========================
	Write Config Byte: Address - 0x4075
	W: 16 00 09 75 40 00 F0
	W: 16 64 AE 01
	============================*/
	{0x09, 0x75, 0x40, 0x00, 0xF0,0xAE, 0x01},
	/*==========================
	Write Config Byte: Address - 0x4076
	W: 16 00 09 76 40 00 F6
	W: 16 64 B5 01
	============================*/
	{0x09, 0x76, 0x40, 0x00, 0xF6,0xB5, 0x01},
	/*==========================
	Write Config Byte: Address - 0x4077
	W: 16 00 09 77 40 00 F7
	W: 16 64 B7 01
	============================*/
	{0x09, 0x77, 0x40, 0x00, 0xF7, 0xB7, 0x01},
	/*==========================
	Write Config Byte: Address - 0x4078
	W: 16 00 09 78 40 00 F9
	W: 16 64 BA 01
	============================*/
	{0x09, 0x78, 0x40, 0x00, 0xF9, 0xBA, 0x01},
	/*==========================
	Write Config Byte: Address - 0x4079
	W: 16 00 09 79 40 00 F9
	W: 16 64 BB 01
	============================*/
	{0x09, 0x79, 0x40, 0x00, 0xF9, 0xBB, 0x01},
	/*==========================
	Write Config Byte: Address - 0x407a
	W: 16 00 09 7A 40 00 FB
	W: 16 64 BE 01
	============================*/
	{0x09, 0x7A, 0x40, 0x00, 0xFB,0xBE, 0x01},
	/*==========================
	Write Config Byte: Address - 0x407b
	W: 16 00 09 7B 40 00 FC
	W: 16 64 C0 01
	============================*/	
	{0x09, 0x7B, 0x40, 0x00, 0xFC,0xC0, 0x01},
	/*==========================
	Write Config Byte: Address - 0x407c
	W: 16 00 09 7C 40 00 FC
	W: 16 64 C1 01
	============================*/
	{0x09, 0x7C, 0x40, 0x00, 0xFC, 0xC1, 0x01},
	/*==========================
	Write Config Byte: Address - 0x407d
	W: 16 00 09 7D 40 00 FF
	W: 16 64 C5 01
	============================*/
	{0x09, 0x7D, 0x40, 0x00, 0xFF, 0xC5, 0x01},
	/*==========================
	Write Config Byte: Address - 0x407e
	W: 16 00 09 7E 40 00 FF
	W: 16 64 C6 01
	============================*/
	{0x09, 0x7E, 0x40, 0x00, 0xFF, 0xC6, 0x01},
	/*==========================
	Write Config Byte: Address - 0x407f
	W: 16 00 09 7F 40 00 FE
	W: 16 64 C6 01
	============================*/
	{0x09, 0x7F, 0x40, 0x00, 0xFE,0xC6, 0x01},

	/*==========================
	Write Config Byte: Address - 0x4080
	W: 16 00 09 80 40 00 FB
	W: 16 64 C4 01
	============================*/
	{0x09, 0x80, 0x40, 0x00, 0xFB, 0xC4, 0x01},
	/*==========================
	Write Config Byte: Address - 0x4081
	W: 16 00 09 81 40 00 F6
	W: 16 64 C0 01
	============================*/
	{0x09, 0x81, 0x40, 0x00, 0xF6, 0xC0, 0x01},
	/*==========================
	Write Config Byte: Address - 0x4082
	W: 16 00 09 82 40 00 F4
	W: 16 64 BF 01
	============================*/
	{0x09, 0x82, 0x40, 0x00, 0xF4, 0xBF, 0x01},	
	/*==========================
	Write Config Byte: Address - 0x4083
	W: 16 00 09 83 40 00 EE
	W: 16 64 BA 01
	============================*/
	{0x09, 0x83, 0x40, 0x00, 0xEE, 0xBA, 0x01},	
	/*==========================
	Write Config Byte: Address - 0x4084
	W: 16 00 09 84 40 00 EB
	W: 16 64 B8 01
	============================*/
	{0x09, 0x84, 0x40, 0x00, 0xEB, 0xB8, 0x01},
	/*==========================
	Write Config Byte: Address - 0x4085
	W: 16 00 09 85 40 00 F6
	W: 16 64 C4 01
	============================*/
	{0x09, 0x85, 0x40, 0x00, 0xF6, 0xC4, 0x01},
	/*==========================
	Write Config Byte: Address - 0x4086
	W: 16 00 09 86 40 00 FA
	W: 16 64 C9 01
	============================*/
	{0x09, 0x86, 0x40, 0x00, 0xFA, 0xC9, 0x01},
	/*==========================
	Write Config Byte: Address - 0x4087
	W: 16 00 09 87 40 00 E1
	W: 16 64 B1 01
	============================*/
	{0x09, 0x87, 0x40, 0x00, 0xE1, 0xB1, 0x01},
	/*==========================
	Write Config Byte: Address - 0x4088
	W: 16 00 09 88 40 00 F6
	W: 16 64 C7 01
	============================*/
	{0x09, 0x88, 0x40, 0x00, 0xF6, 0xC7, 0x01},
	/*==========================
	Write Config Byte: Address - 0x4089
	W: 16 00 09 89 40 00 DF
	W: 16 64 B1 01
	============================*/
	{0x09, 0x89, 0x40, 0x00, 0xDF, 0xB1, 0x01},
	/*==========================
	Write Config Byte: Address - 0x408a
	W: 16 00 09 8A 40 00 80
	W: 16 64 53 01
	============================*/
	{0x09, 0x8A, 0x40, 0x00, 0x80, 0x53, 0x01},
	/*==========================
	Write Config Byte: Address - 0x408b
	W: 16 00 09 8B 40 00 00
	W: 16 64 D4 00
	============================*/
	{0x09, 0x8B, 0x40, 0x00, 0x00, 0xD4, 0x00},
	/*==========================
	Write Config Byte: Address - 0x408c
	W: 16 00 09 8C 40 00 FF
	W: 16 64 D4 01
	============================*/
	{0x09, 0x8C, 0x40, 0x00, 0xFF, 0xD4, 0x01},
	/*==========================
	Write Config Byte: Address - 0x408d
	W: 16 00 09 8D 40 00 2B
	W: 16 64 01 01
	============================*/
	{0x09, 0x8D, 0x40, 0x00, 0x2B, 0x01, 0x01},
	/*==========================
	Write Config Byte: Address - 0x408e
	W: 16 00 09 8E 40 00 05
	W: 16 64 DC 00
	============================*/
	{0x09, 0x8E, 0x40, 0x00, 0x05, 0xDC, 0x00},
	/*==========================
	Write Config Byte: Address - 0x408f
	W: 16 00 09 8F 40 00 01
	W: 16 64 D9 00
	============================*/
	{0x09, 0x8F, 0x40, 0x00, 0x01, 0xD9, 0x00},

	/*==========================
	Write Config Byte: Address - 0x4090
	W: 16 00 09 90 40 00 01
	W: 16 64 DA 00
	============================*/
	{0x09, 0x90, 0x40, 0x00, 0x01, 0xDA, 0x00},
	/*==========================
	Write Config Byte: Address - 0x4091
	W: 16 00 09 91 40 00 00
	W: 16 64 DA 00
	============================*/
	{0x09, 0x91, 0x40, 0x00, 0x00, 0xDA, 0x00},
	/*==========================
	Write Config Byte: Address - 0x4092
	W: 16 00 09 92 40 00 00
	W: 16 64 DB 00
	============================*/
	{0x09, 0x92, 0x40, 0x00, 0x00, 0xDB, 0x00},	
	/*==========================
	Write Config Byte: Address - 0x4093
	W: 16 00 09 93 40 00 FF
	W: 16 64 DB 01
	============================*/
	{0x09, 0x93, 0x40, 0x00, 0xFF, 0xDB, 0x01},	
	/*==========================
	Write Config Byte: Address - 0x4094
	W: 16 00 09 94 40 00 FF
	W: 16 64 DC 01
	============================*/
	{0x09, 0x94, 0x40, 0x00, 0xFF, 0xDC, 0x01},
	/*==========================
	Write Config Byte: Address - 0x4095
	W: 16 00 09 95 40 00 00
	W: 16 64 DE 00
	============================*/
	{0x09, 0x95, 0x40, 0x00, 0x00, 0xDE, 0x00},
	/*==========================
	Write Config Byte: Address - 0x4096
	W: 16 00 09 96 40 00 00
	W: 16 64 DF 00
	============================*/
	{0x09, 0x96, 0x40, 0x00, 0x00, 0xDF, 0x00},
	/*==========================
	Write Config Byte: Address - 0x4097
	W: 16 00 09 97 40 00 FE
	W: 16 64 DE 01
	============================*/
	{0x09, 0x97, 0x40, 0x00, 0xFE, 0xDE, 0x01},
	/*==========================
	Write Config Byte: Address - 0x4098
	W: 16 00 09 98 40 00 FE
	W: 16 64 DF 01
	============================*/
	{0x09, 0x98, 0x40, 0x00, 0xFE, 0xDF, 0x01},
	/*==========================
	Write Config Byte: Address - 0x4099
	W: 16 00 09 99 40 00 FE
	W: 16 64 E0 01
	============================*/
	{0x09, 0x99, 0x40, 0x00, 0xFE, 0xE0, 0x01},
	/*==========================
	Write Config Byte: Address - 0x409a
	W: 16 00 09 9A 40 00 FF
	W: 16 64 E2 01
	============================*/
	{0x09, 0x9A, 0x40, 0x00, 0xFF, 0xE2, 0x01},
	/*==========================
	Write Config Byte: Address - 0x409b
	W: 16 00 09 9B 40 00 01
	W: 16 64 E5 00
	============================*/
	{0x09, 0x9B, 0x40, 0x00, 0x01, 0xE5, 0x00},
	/*==========================
	Write Config Byte: Address - 0x409c
	W: 16 00 09 9C 40 00 03
	W: 16 64 E8 00
	============================*/
	{0x09, 0x9C, 0x40, 0x00, 0x03, 0xE8, 0x00},
	/*==========================
	Write Config Byte: Address - 0x409d
	W: 16 00 09 9D 40 00 09
	W: 16 64 EF 00
	============================*/
	{0x09, 0x9D, 0x40, 0x00, 0x09, 0xEF, 0x00},
	/*==========================
	Write Config Byte: Address - 0x409e
	W: 16 00 09 9E 40 00 05
	W: 16 64 EC 00
	============================*/
	{0x09, 0x9E, 0x40, 0x00, 0x05, 0xEC, 0x00},
	/*==========================
	Write Config Byte: Address - 0x409f
	W: 16 00 09 9F 40 00 FD
	W: 16 64 E5 01
	============================*/
	{0x09, 0x9F, 0x40, 0x00, 0xFD, 0xE5, 0x01},

	/*==========================
	Write Config Byte: Address - 0x40a0
	W: 16 00 09 A0 40 00 FE
	W: 16 64 E7 01
	============================*/
	{0x09, 0xA0, 0x40, 0x00, 0xFE, 0xE7, 0x01},
	/*==========================
	Write Config Byte: Address - 0x40a1
	W: 16 00 09 A1 40 00 FF
	W: 16 64 E9 01
	============================*/
	{0x09, 0xA1, 0x40, 0x00, 0xFF, 0xE9, 0x01},
	/*==========================
	Write Config Byte: Address - 0x40a2
	W: 16 00 09 A2 40 00 FF
	W: 16 64 EA 01
	============================*/
	{0x09, 0xA2, 0x40, 0x00, 0xFF, 0xEA, 0x01},	
	/*==========================
	Write Config Byte: Address - 0x40a3
	W: 16 00 09 A3 40 00 FF
	W: 16 64 EB 01
	============================*/
	{0x09, 0xA3, 0x40, 0x00, 0xFF, 0xEB, 0x01},	
	/*==========================
	Write Config Byte: Address - 0x40a4
	W: 16 00 09 A4 40 00 FF
	W: 16 64 EC 01
	============================*/
	{0x09, 0xA4, 0x40, 0x00, 0xFF, 0xEC, 0x01},
	/*==========================
	Write Config Byte: Address - 0x40a5
	W: 16 00 09 A5 40 00 FE
	W: 16 64 EC 01
	============================*/
	{0x09, 0xA5, 0x40, 0x00, 0xFE, 0xEC, 0x01},
	/*==========================
	Write Config Byte: Address - 0x40a6
	W: 16 00 09 A6 40 00 FD
	W: 16 64 EC 01
	============================*/
	{0x09, 0xA6, 0x40, 0x00, 0xFD, 0xEC, 0x01},
	/*==========================
	Write Config Byte: Address - 0x40a7
	W: 16 00 09 A7 40 00 FC
	W: 16 64 EC 01
	============================*/
	{0x09, 0xA7, 0x40, 0x00, 0xFC, 0xEC, 0x01},
	/*==========================
	Write Config Byte: Address - 0x40a8
	W: 16 00 09 A8 40 00 F5
	W: 16 64 E6 01
	============================*/
	{0x09, 0xA8, 0x40, 0x00, 0xF5, 0xE6, 0x01},
	/*==========================
	Write Config Byte: Address - 0x40a9
	W: 16 00 09 A9 40 00 EE
	W: 16 64 E0 01
	============================*/
	{0x09, 0xA9, 0x40, 0x00, 0xEE, 0xE0, 0x01},
	/*==========================
	Write Config Byte: Address - 0x40aa
	W: 16 00 09 AA 40 00 F2
	W: 16 64 E5 01
	============================*/
	{0x09, 0xAA, 0x40, 0x00, 0xF2, 0xE5, 0x01},
	/*==========================
	Write Config Byte: Address - 0x40ab
	W: 16 00 09 AB 40 00 F4
	W: 16 64 E8 01
	============================*/
	{0x09, 0xAB, 0x40, 0x00, 0xF4, 0xE8, 0x01},
	/*==========================
	Write Config Byte: Address - 0x40ac
	W: 16 00 09 AC 40 00 FE
	W: 16 64 F3 01
	============================*/
	{0x09, 0xAC, 0x40, 0x00, 0xFE, 0xF3, 0x01},
	/*==========================
	Write Config Byte: Address - 0x40ad
	W: 16 00 09 AD 40 00 04
	W: 16 64 FA 00
	============================*/
	{0x09, 0xAD, 0x40, 0x00, 0x04, 0xFA, 0x00},
	/*==========================
	Write Config Byte: Address - 0x40ae
	W: 16 00 09 AE 40 00 02
	W: 16 64 F9 00
	============================*/
	{0x09, 0xAE, 0x40, 0x00, 0x02, 0xF9, 0x00},
	/*==========================
	Write Config Byte: Address - 0x40af
	W: 16 00 09 AF 40 00 02
	W: 16 64 FA 00
	============================*/
	{0x09, 0xAF, 0x40, 0x00, 0x02, 0xFA, 0x00},

	/*==========================
	Write Config Byte: Address - 0x40b0
	W: 16 00 09 B0 40 00 06
	W: 16 64 FF 00
	============================*/
	{0x09, 0xB0, 0x40, 0x00, 0x06, 0xFF, 0x00},
	/*==========================
	Write Config Byte: Address - 0x40b1
	W: 16 00 09 B1 40 00 08
	W: 16 64 02 01
	============================*/
	{0x09, 0xB1, 0x40, 0x00, 0x08, 0x02, 0x01},
	/*==========================
	Write Config Byte: Address - 0x40b2
	W: 16 00 09 B2 40 00 FE
	W: 16 64 F9 01
	============================*/
	{0x09, 0xB2, 0x40, 0x00, 0xFE, 0xF9, 0x01},	
	/*==========================
	Write Config Byte: Address - 0x40b3
	W: 16 00 09 B3 40 00 FB
	W: 16 64 F7 01
	============================*/
	{0x09, 0xB3, 0x40, 0x00, 0xFB, 0xF7, 0x01},	
	/*==========================
	Write Config Byte: Address - 0x40b4
	W: 16 00 09 B4 40 00 9C
	W: 16 64 99 01
	============================*/
	{0x09, 0xB4, 0x40, 0x00, 0x9C, 0x99, 0x01},
	/*==========================
	Write Config Byte: Address - 0x40b5
	W: 16 00 09 B5 40 00 81
	W: 16 64 7F 01
	============================*/
	{0x09, 0xB5, 0x40, 0x00, 0x81, 0x7F, 0x01},
	/*==========================
	Write Config Byte: Address - 0x40b6
	W: 16 00 09 B6 40 00 FF
	W: 16 64 FE 01
	============================*/
	{0x09, 0xB6, 0x40, 0x00, 0xFF, 0xFE, 0x01},
	/*==========================
	Write Config Byte: Address - 0x40b7
	W: 16 00 09 B7 40 00 BA
	W: 16 64 BA 01
	============================*/
	{0x09, 0xB7, 0x40, 0x00, 0xBA, 0xBA, 0x01},
	/*==========================
	Write Config Byte: Address - 0x40b8
	W: 16 00 09 B8 40 00 00
	W: 16 64 01 01
	============================*/
	{0x09, 0xB8, 0x40, 0x00, 0x00, 0x01, 0x01},
	/*==========================
	Write Config Byte: Address - 0x40b9
	W: 16 00 09 B9 40 00 00
	W: 16 64 02 01
	============================*/
	{0x09, 0xB9, 0x40, 0x00, 0x00, 0x02, 0x01},
	/*==========================
	Write Config Byte: Address - 0x40ba
	W: 16 00 09 BA 40 00 F9
	W: 16 64 FC 01
	============================*/
	{0x09, 0xBA, 0x40, 0x00, 0xF9, 0xFC, 0x01},
	/*==========================
	Write Config Byte: Address - 0x40bb
	W: 16 00 09 BB 40 00 E5
	W: 16 64 E9 01
	============================*/
	{0x09, 0xBB, 0x40, 0x00, 0xE5, 0xE9, 0x01},
	/*==========================
	Write Config Byte: Address - 0x40bc
	W: 16 00 09 BC 40 00 28
	W: 16 64 2D 01
	============================*/
	{0x09, 0xBC, 0x40, 0x00, 0x28, 0x2D, 0x01},
	/*==========================
	Write Config Byte: Address - 0x40bd
	W: 16 00 09 BD 40 00 17
	W: 16 64 1D 01
	============================*/
	{0x09, 0xBD, 0x40, 0x00, 0x17, 0x1D, 0x01},
	/*==========================
	Write Config Byte: Address - 0x40be
	W: 16 00 09 BE 40 00 D1
	W: 16 64 D8 01
	============================*/
	{0x09, 0xBE, 0x40, 0x00, 0xD1, 0xD8, 0x01},
	/*==========================
	Write Config Byte: Address - 0x40bf
	W: 16 00 09 BF 40 00 1F
	W: 16 64 27 01
	============================*/
	{0x09, 0xBF, 0x40, 0x00, 0x1F, 0x27, 0x01},

	/*==========================
	Write Config Byte: Address - 0x40c0
	W: 16 00 09 C0 40 00 07
	W: 16 64 10 01
	============================*/
	{0x09, 0xC0, 0x40, 0x00, 0x07, 0x10, 0x01},
	/*==========================
	Write Config Byte: Address - 0x40c1
	W: 16 00 09 C1 40 00 08
	W: 16 64 12 01
	============================*/
	{0x09, 0xC1, 0x40, 0x00, 0x08, 0x12, 0x01},
	/*==========================
	Write Config Byte: Address - 0x40c2
	W: 16 00 09 C2 40 00 01
	W: 16 64 0C 01
	============================*/
	{0x09, 0xC2, 0x40, 0x00, 0x01, 0x0C, 0x01},	
	/*==========================
	Write Config Byte: Address - 0x40c3
	W: 16 00 09 C3 40 00 09
	W: 16 64 15 01
	============================*/
	{0x09, 0xC3, 0x40, 0x00, 0x09, 0x15, 0x01},	
	/*==========================
	Write Config Byte: Address - 0x40c4
	W: 16 00 09 C4 40 00 13
	W: 16 64 20 01
	============================*/
	{0x09, 0xC4, 0x40, 0x00, 0x13, 0x20, 0x01},
	/*==========================
	Write Config Byte: Address - 0x40c5
	W: 16 00 09 C5 40 00 E0
	W: 16 64 EE 01
	============================*/
	{0x09, 0xC5, 0x40, 0x00, 0xE0, 0xEE, 0x01},
	/*==========================
	Write Config Byte: Address - 0x40c6
	W: 16 00 09 C6 40 00 EA
	W: 16 64 F9 01
	============================*/
	{0x09, 0xC6, 0x40, 0x00, 0xEA, 0xF9, 0x01},
	/*==========================
	Write Config Byte: Address - 0x40c7
	W: 16 00 09 C7 40 00 FF
	W: 16 64 0F 02
	============================*/
	{0x09, 0xC7, 0x40, 0x00, 0xFF, 0x0F, 0x02},
	/*==========================
	Write Config Byte: Address - 0x40c8
	W: 16 00 09 C8 40 00 00
	W: 16 64 11 01
	============================*/
	{0x09, 0xC8, 0x40, 0x00, 0x00, 0x11, 0x01},
	/*==========================
	Write Config Byte: Address - 0x40c9
	W: 16 00 09 C9 40 00 00
	W: 16 64 12 01
	============================*/
	{0x09, 0xC9, 0x40, 0x00, 0x00, 0x12, 0x01},
	/*==========================
	Write Config Byte: Address - 0x40ca
	W: 16 00 09 CA 40 00 00
	W: 16 64 13 01
	============================*/
	{0x09, 0xCA, 0x40, 0x00, 0x00, 0x13, 0x01},
	/*==========================
	Write Config Byte: Address - 0x40cb
	W: 16 00 09 CB 40 00 F2
	W: 16 64 06 02
	============================*/
	{0x09, 0xCB, 0x40, 0x00, 0xF2, 0x06, 0x02},
	/*==========================
	Write Config Byte: Address - 0x40cc
	W: 16 00 09 CC 40 00 08
	W: 16 64 1D 01
	============================*/
	{0x09, 0xCC, 0x40, 0x00, 0x08, 0x1D, 0x01},
	/*==========================
	Write Config Byte: Address - 0x40cd
	W: 16 00 09 CD 40 00 CE
	W: 16 64 E4 01
	============================*/
	{0x09, 0xCD, 0x40, 0x00, 0xCE, 0xE4, 0x01},
	/*==========================
	Write Config Byte: Address - 0x40ce
	W: 16 00 09 CE 40 00 DB
	W: 16 64 F2 01
	============================*/
	{0x09, 0xCE, 0x40, 0x00, 0xDB, 0xF2, 0x01},
	/*==========================
	Write Config Byte: Address - 0x40cf
	W: 16 00 09 CF 40 00 E6
	W: 16 64 FE 01
	============================*/
	{0x09, 0xCF, 0x40, 0x00, 0xE6, 0xFE, 0x01},

	/*==========================
	Write Config Byte: Address - 0x40d0
	W: 16 00 09 D0 40 00 C2
	W: 16 64 DB 01
	============================*/
	{0x09, 0xD0, 0x40, 0x00, 0xC2, 0xDB, 0x01},
	/*==========================
	Write Config Byte: Address - 0x40d1
	W: 16 00 09 D1 40 00 D3
	W: 16 64 ED 01
	============================*/	
	{0x09, 0xD1, 0x40, 0x00, 0xD3, 0xED, 0x01},
	/*==========================
	Write Config Byte: Address - 0x40d2
	W: 16 00 09 D2 40 00 E5
	W: 16 64 00 02
	============================*/
	{0x09, 0xD2, 0x40, 0x00, 0xE5, 0x00, 0x02},
	/*==========================
	Write Config Byte: Address - 0x40d3
	W: 16 00 09 D3 40 00 12
	W: 16 64 2E 01
	============================*/
	{0x09, 0xD3, 0x40, 0x00, 0x12, 0x2E, 0x01},
	/*==========================
	Write Config Byte: Address - 0x40d4
	W: 16 00 09 D4 40 00 FF
	W: 16 64 1C 02
	============================*/
	{0x09, 0xD4, 0x40, 0x00, 0xFF, 0x1C, 0x02},
	/*==========================
	Write Config Byte: Address - 0x40d5
	W: 16 00 09 D5 40 00 2E
	W: 16 64 4C 01
	============================*/
	{0x09, 0xD5, 0x40, 0x00, 0x2E, 0x4C, 0x01},
	/*==========================
	Write Config Byte: Address - 0x40d6
	W: 16 00 09 D6 40 00 65
	W: 16 64 84 01
	============================*/
	{0x09, 0xD6, 0x40, 0x00, 0x65, 0x84, 0x01},
	/*==========================
	Write Config Byte: Address - 0x40d7
	W: 16 00 09 D7 40 00 1A
	W: 16 64 3A 01
	============================*/
	{0x09, 0xD7, 0x40, 0x00, 0x1A, 0x3A, 0x01},
	/*==========================
	Write Config Byte: Address - 0x40d8
	W: 16 00 09 D8 40 00 00
	W: 16 64 21 01
	============================*/
	{0x09, 0xD8, 0x40, 0x00, 0x00, 0x21, 0x01},
	/*==========================
	Write Config Byte: Address - 0x40d9
	W: 16 00 09 D9 40 00 00
	W: 16 64 22 01
	============================*/
	{0x09, 0xD9, 0x40, 0x00, 0x00, 0x22, 0x01},
	/*==========================
	Write Config Byte: Address - 0x40da
	W: 16 00 09 DA 40 00 00
	W: 16 64 23 01
	============================*/
	{0x09, 0xDA, 0x40, 0x00, 0x00, 0x23, 0x01},
	/*==========================
	Write Config Byte: Address - 0x40db
	W: 16 00 09 DB 40 00 00
	W: 16 64 24 01
	============================*/
	{0x09, 0xDB, 0x40, 0x00, 0x00, 0x24, 0x01},
	/*==========================
	Write Config Byte: Address - 0x40dc
	W: 16 00 09 DC 40 00 00
	W: 16 64 25 01
	============================*/
	{0x09, 0xDC, 0x40, 0x00, 0x00, 0x25, 0x01},
	/*==========================
	Write Config Byte: Address - 0x40dd
	W: 16 00 09 DD 40 00 00
	W: 16 64 26 01
	============================*/
	{0x09, 0xDD, 0x40, 0x00, 0x00, 0x26, 0x01},
	/*==========================
	Write Config Byte: Address - 0x40de
	W: 16 00 09 DE 40 00 00
	W: 16 64 27 01
	============================*/
	{0x09, 0xDE, 0x40, 0x00, 0x00, 0x27, 0x01},
	/*==========================
	Write Config Byte: Address - 0x40df
	W: 16 00 09 DF 40 00 00
	W: 16 64 28 01
	============================*/
	{0x09, 0xDF, 0x40, 0x00, 0x00, 0x28, 0x01}
};

/* If the system has several batteries we need a different name for each
 * of them...
 */
struct bq27425_device_info {
	struct device 		*dev;
	struct power_supply	bat;
	struct power_supply	ac;
	struct delayed_work work;
	struct delayed_work wakeup_work;
	struct i2c_client	*client;
	int wake_irq;
	unsigned int interval;
	unsigned int dc_check_pin;
	unsigned int bat_check_pin;
	unsigned int bat_num;
	int power_down;
};
  
static struct bq27425_device_info *bq27425_di;
static enum power_supply_property bq27425_battery_props[] = {
	POWER_SUPPLY_PROP_STATUS,
	POWER_SUPPLY_PROP_PRESENT,
	POWER_SUPPLY_PROP_VOLTAGE_NOW,
	POWER_SUPPLY_PROP_CURRENT_NOW,
	POWER_SUPPLY_PROP_CAPACITY,
	POWER_SUPPLY_PROP_CAPACITY_LEVEL,
	POWER_SUPPLY_PROP_TEMP,
	POWER_SUPPLY_PROP_TECHNOLOGY,
};

static enum power_supply_property rk29_ac_props[] = {
	POWER_SUPPLY_PROP_ONLINE,
};

static ssize_t battery_proc_write(struct file *file,const char __user *buffer,
			 unsigned long count,void *data)
{
	char c;
	int rc;
	printk("USER:\n");
	printk("echo x >/proc/driver/power\n");
	printk("x=1,means just print log ||x=2,means log and data ||x= other,means close log\n");

	rc = get_user(c,buffer);
	if(rc)
		return rc;
	
	//added by zwp,c='8' means check whether we need to download firmware to bq27xxx,return 0 means yes.
	if(c == '8'){
		printk("%s,bq27425 don't need to download firmware\n",__FUNCTION__);
		return -1;//bq27425 don't need to download firmware.
	}
	if(c == '1')
		virtual_battery_enable = 1;
	else if(c == '2')
		virtual_battery_enable = 2;
	else if(c == '3')
		virtual_battery_enable = 3;
	else if(c == '9'){
		printk("%s:%d>>bq27425 set\n",__FUNCTION__,__LINE__);

	}
	else 
		virtual_battery_enable = 0;
	DBG("%s,count(%d),virtual_battery_enable(%d)\n",__FUNCTION__,(int)count,virtual_battery_enable);
	return count;
}

static const struct file_operations battery_proc_fops = {
	.owner		= THIS_MODULE, 
	.write		= battery_proc_write,
}; 

/*
 * Common code for BQ27425 devices read
 */
static int bq27425_read(struct i2c_client *client, u8 reg, u8 buf[], unsigned len)
{
	int ret;
	ret = i2c_master_reg8_recv(client, reg, buf, len, BQ27425_SPEED);
	return ret; 
}

static int bq27425_write(struct i2c_client *client, u8 reg, u8 const buf[], unsigned len)
{
	int ret; 
	ret = i2c_master_reg8_send(client, reg, buf, (int)len, BQ27425_SPEED);
	return ret;
}

static int bq27425_write_byte(struct i2c_client *client, u8 reg, u16 const buf[], unsigned len)
{
	int ret; 
	ret = i2c_master_reg16_send(client, reg, buf, (int)len, BQ27425_SPEED);
	return ret;
}

/*
 * Return the battery temperature in tenths of degree Celsius
 * Or < 0 if something fails.
 */
 
static irqreturn_t bq27425_bat_wakeup(int irq, void *dev_id)
{	
	struct bq27425_device_info *di = (struct bq27425_device_info *)dev_id;

	printk("!!!  bq27425 bat_low irq low vol !!!\n\n\n");
	disable_irq_wake(di->wake_irq);

	schedule_delayed_work(&di->wakeup_work, msecs_to_jiffies(0));	
	return IRQ_HANDLED;
}

static void bq27425_battery_wake_work(struct work_struct *work)
{
	int ret;
	struct bq27425_device_info *di = 
		(struct bq27425_device_info *)container_of(work, struct bq27425_device_info, wakeup_work.work);

	rk28_send_wakeup_key();

	free_irq(di->wake_irq, di);
	di->wake_irq = gpio_to_irq(di->wake_irq);
	
	ret = request_irq(di->wake_irq, bq27425_bat_wakeup, IRQF_TRIGGER_FALLING, "bq27425_battery", di);
	if (ret) {
		printk("request faild!\n");
		return;
	}
	enable_irq_wake(di->wake_irq);
}

static int bq27425_battery_temperature(struct bq27425_device_info *di)
{
	int ret;
	int temp = 0;
	u8 buf[2] ={0};

	if(virtual_battery_enable == 1)
		return 125/*258*/;

	ret = bq27425_read(di->client,BQ27425_REG_TEMP,buf,2);
	if (ret<0) {
		dev_err(di->dev, "error reading temperature\n");
		return ret;
	}

	temp = get_unaligned_le16(buf);
	//temp = 5 * temp / 2;
	temp = temp - 2731;  //K

	DBG("Enter:%s %d--temp = %d\n",__FUNCTION__,__LINE__,temp);

	return temp;
}

/*
 * Return the battery Voltage in milivolts
 * Or < 0 if something fails.
 */



static int bq27425_battery_voltage(struct bq27425_device_info *di)
{
	int ret;
	u8 buf[2] = {0};
	int volt = 0;

	if(virtual_battery_enable == 1)
		return 2000000/*4000000*/;

	ret = bq27425_read(di->client,BQ27425_REG_VOL,buf,2); 
	if (ret<0) {
		dev_err(di->dev, "error reading voltage\n");
		return ret;
	}

	volt = get_unaligned_le16(buf);

	if(di->bat_num == 2){
		volt = volt * 1000 * 2;
	}else{
		volt = volt * 1000;
	}

	DBG("Enter:%s %d--volt = %d\n",__FUNCTION__,__LINE__,volt);

	return volt;
}

/*
 * Return the battery average current
 * Note that current can be negative signed as well
 * Or 0 if something fails.
 */
static int bq27425_battery_current(struct bq27425_device_info *di)
{
	int ret;
	int curr = 0;
	u8 buf[2] = {0};

	if(virtual_battery_enable == 1)
		return 11000/*22000*/;

	ret = bq27425_read(di->client,BQ27425_REG_AVERAGE_CURRENT,buf,2);
	if (ret<0) {
		dev_err(di->dev, "error reading current\n");
		return 0;
	}

	curr = get_unaligned_le16(buf);
	DBG("curr = %x \n",curr);

	if(curr > 0x8000){
		curr = 0xFFFF ^ (curr -1);
	}

	curr = curr * 1000;

	DBG("Enter:%s %d--curr = %d\n",__FUNCTION__,__LINE__,curr);

	return curr;
}

/*
 * Return the battery Relative State-of-Charge
 * Or < 0 if something fails.
 */
static int bq27425_battery_rsoc(struct bq27425_device_info *di)
{
	int ret;
	int rsoc = 0;
	int flags = 0;
	int status = 0;
	u8 buf[2];

	if(virtual_battery_enable == 1)
		return 50/*100*/;
	
	ret = bq27425_read(di->client,BQ27425_REG_STATE_OF_CHARGER,buf,2); 
	if (ret<0) {
		dev_err(di->dev, "error reading relative State-of-Charge\n");
		return ret;
	}

	rsoc = get_unaligned_le16(buf);
	DBG("Enter:%s %d--read reaming capacity = %d\n",__FUNCTION__,__LINE__,rsoc);

	/* covert the capacity range */
	rsoc = min(rsoc, 100);
	if ((g_pdata != NULL) && g_pdata->capacity_max && g_pdata->capacity_min) {
		rsoc = max(rsoc, g_pdata->capacity_min);
		rsoc = ((rsoc - g_pdata->capacity_min) * 100 +
			(g_pdata->capacity_max - g_pdata->capacity_min) / 2)
			/ (g_pdata->capacity_max - g_pdata->capacity_min);
	}

	/*check full flags,if not full, show 99%*/
	ret = bq27425_read(di->client,BQ27425_REG_FLAGS, buf, 2);
	if (ret < 0) {
		dev_err(di->dev, "error reading flags\n");
		return ret;
	}

	flags = get_unaligned_le16(buf);
	DBG("Enter:%s %d--flags = 0x%x\n",__FUNCTION__,__LINE__,flags);

	if (flags & BQ27425_FLAG_FC)
		status = POWER_SUPPLY_STATUS_FULL;

	if(status != POWER_SUPPLY_STATUS_FULL)
		rsoc = min(rsoc, 99);

	DBG("Enter:%s %d--cal rsoc = %d\n",__FUNCTION__,__LINE__,rsoc);

	return rsoc;
}

static int bq27425_battery_rsoc_level(struct bq27425_device_info *di,
								union power_supply_propval *val)
{
	u8 buf[2] = {0};
	int flags = 0;
	int status = 0;
	int ret = 0;

	if(virtual_battery_enable == 1)
	{
		val->intval = POWER_SUPPLY_STATUS_FULL;
		return 0;
	}

	ret = bq27425_read(di->client,BQ27425_REG_FLAGS, buf, 2);
	if (ret < 0) {
		dev_err(di->dev, "error reading flags\n");
		return ret;
	}

	flags = get_unaligned_le16(buf);

	DBG("Enter:%s %d--flags = 0x%x\n",__FUNCTION__,__LINE__,flags);

	if (flags & BQ27425_FLAG_FC)
		status = POWER_SUPPLY_STATUS_FULL;
	else if (flags & BQ27425_FLAG_SOC1)
		status = POWER_SUPPLY_CAPACITY_LEVEL_LOW;
	else if (flags & BQ27425_FLAG_SOCF)
		status = POWER_SUPPLY_CAPACITY_LEVEL_CRITICAL;
	else
		status = POWER_SUPPLY_CAPACITY_LEVEL_NORMAL;

	val->intval = status;

	DBG("Enter:%s %d--status = %x\n",__FUNCTION__,__LINE__,status);
	return 0;

}

static int bq27425_battery_status(struct bq27425_device_info *di,
				  union power_supply_propval *val)
{
	u8 buf[2] = {0};
	int flags = 0;
	int status = 0;
	int ret = 0;

	if(virtual_battery_enable == 1)
	{
		val->intval = POWER_SUPPLY_STATUS_FULL;
		return 0;
	}

	ret = bq27425_read(di->client,BQ27425_REG_FLAGS, buf, 2);
	if (ret < 0) {
		dev_err(di->dev, "error reading flags\n");
		return ret;
	}

	flags = get_unaligned_le16(buf);

	DBG("Enter:%s %d--flags = 0x%x\n",__FUNCTION__,__LINE__,flags);

	if (flags & BQ27425_FLAG_FC)
		status = POWER_SUPPLY_STATUS_FULL;
	else if ((g_pdata != NULL) && g_pdata->get_charging_stat)
	{
		if(!(*g_pdata->get_charging_stat)())
			status = POWER_SUPPLY_STATUS_DISCHARGING;
		else
			status = POWER_SUPPLY_STATUS_CHARGING;
	}

	val->intval = status;

	DBG("Enter:%s %d--status = %x\n",__FUNCTION__,__LINE__,status);
	return 0;
}

static int bq27425_health_status(struct bq27425_device_info *di,
				  union power_supply_propval *val)
{
	u8 buf[2] = {0};
	int flags = 0;
	int status;
	int ret;
	
	if(virtual_battery_enable == 1)
	{
		val->intval = POWER_SUPPLY_HEALTH_GOOD;
		return 0;
	}

	ret = bq27425_read(di->client,BQ27425_REG_FLAGS, buf, 2);
	if (ret < 0) {
		dev_err(di->dev, "error reading flags\n");
		return ret;
	}

	flags = get_unaligned_le16(buf);
	DBG("Enter:%s %d--status = %x\n",__FUNCTION__,__LINE__,flags);
	
	if (flags & BQ27425_FLAG_SOCF)
		status = POWER_SUPPLY_HEALTH_DEAD;
	else if(flags & BQ27425_FLAG_OTC)
		status = POWER_SUPPLY_HEALTH_OVERHEAT;
	else
		status = POWER_SUPPLY_HEALTH_GOOD;

	val->intval = status;

	return 0;
}


#define to_bq27425_device_info(x) container_of((x), \
				struct bq27425_device_info, bat);
   
static int bq27425_battery_get_property(struct power_supply *psy,
					enum power_supply_property psp,
					union power_supply_propval *val)
{
	int ret = 0;
	
	struct bq27425_device_info *di = to_bq27425_device_info(psy);
	DBG("Enter:%s %d psp= %d\n",__FUNCTION__,__LINE__,psp);
	
	switch (psp) {

	case POWER_SUPPLY_PROP_STATUS:
		ret = bq27425_battery_status(di, val);
		break;
	case POWER_SUPPLY_PROP_VOLTAGE_NOW:
		val->intval = bq27425_battery_voltage(di);
		break;
	case POWER_SUPPLY_PROP_PRESENT:
		val->intval = 1;
		break;
	case POWER_SUPPLY_PROP_CURRENT_NOW:
		val->intval = bq27425_battery_current(di);
		break;
	case POWER_SUPPLY_PROP_CAPACITY:
		val->intval = bq27425_battery_rsoc(di);
		break;
	case POWER_SUPPLY_PROP_CAPACITY_LEVEL:
		ret = bq27425_battery_rsoc_level(di, val);
		break;
	case POWER_SUPPLY_PROP_TEMP:
		val->intval = bq27425_battery_temperature(di);
		break;
	case POWER_SUPPLY_PROP_TECHNOLOGY:
		val->intval = POWER_SUPPLY_TECHNOLOGY_LION;	
		break;
	case POWER_SUPPLY_PROP_HEALTH:
		ret = bq27425_health_status(di, val);
		break;
	
	default:
		return -EINVAL;
	}

	return ret;
}

static void bq27425_powersupply_init(struct bq27425_device_info *di)
{
	di->bat.type = POWER_SUPPLY_TYPE_BATTERY;
	di->bat.properties = bq27425_battery_props;
	di->bat.num_properties = ARRAY_SIZE(bq27425_battery_props);
	di->bat.get_property = bq27425_battery_get_property;
}

static void bq27425_battery_update_status(struct bq27425_device_info *di)
{
	power_supply_changed(&di->bat);
}

static void bq27425_battery_work(struct work_struct *work)
{
	struct bq27425_device_info *di = container_of(work, struct bq27425_device_info, work.work); 
	bq27425_battery_update_status(di);
	/* reschedule for the next time */
	schedule_delayed_work(&di->work, di->interval);
}

static void bq27425_verify_exist_firmware(void)
{
	struct bq27425_device_info *di;
	u8 buf[2];
	
	if(g_bq27425_mode == BQ27425_NORMAL_MODE){
		di = bq27425_di;
		/*W: AA 00 01 00*/
		buf[0] = 0x01;
		buf[1] = 0x00;
		bq27425_write(di->client,0x00,buf,2);
		/*C: AA 00 25 04*/
		buf[0] = 0x25;
		buf[1] = 0x04;
		bq27425_read(di->client,0x00,buf,2);
		/*W: AA 00 02 00*/
		buf[0] = 0x02;
		buf[1] = 0x00;
		bq27425_write(di->client,0x00,buf,2);
		/*C: AA 00 05 02*/
		buf[0] = 0x05;
		buf[1] = 0x02;
		bq27425_read(di->client,0x00,buf,2);
	}
}

static void bq27425_unseal_device(void)
{
	struct bq27425_device_info *di;
	u8 buf[2];

	di = bq27425_di;
	/*W: AA 00 14 04*/
	buf[0] = 0x14;
	buf[1] = 0x04;
	bq27425_write(di->client,0x00,buf,2);
	/*W: AA 00 72 36*/
	buf[0] = 0x72;
	buf[1] = 0x36;
	bq27425_write(di->client,0x00,buf,2);
	/*W: AA 00 FF FF*/
	buf[0] = 0xFF;
	buf[1] = 0xFF;
	bq27425_write(di->client,0x00,buf,2);
	/*W: AA 00 FF FF*/
	buf[0] = 0xFF;
	buf[1] = 0xFF;
	bq27425_write(di->client,0x00,buf,2);
	/*X: 1000*/
	msleep(1000);
}

static void bq27425_enter_rom_mode(void)
{
	struct bq27425_device_info *di;
	u8 buf[6];
	int ret = 2;

	di = bq27425_di;
	if(g_bq27425_mode == BQ27425_NORMAL_MODE){
		/*W: AA 00 00 0F*/
		buf[0] = 0x00;
		buf[1] = 0x0F;
		ret = bq27425_write(di->client,0x00,buf,2);
	}
	/*X: 1000*/
	g_client->addr = 0x0B;//when enter rom mode,the iic addr is 0x0B
	msleep(1000);

	/*W: 16 00 1F 00 00 00 D2 FF*/
	buf[0] = 0x1F ;
	buf[1] = 0x00;
	buf[2] = 0x00;
	buf[3] = 0x00;
	buf[4] = 0xd2;
	buf[5] = 0xff;
	ret = bq27425_write(g_client,0x00,buf,6);

	/*X: 1*/
	msleep(1);
	/*C: 16 66 00*/
	buf[0] = 0x00;
	ret = bq27425_read(g_client,0x66,buf,1);
}

static void bq27425_write_flash_code(void)
{
	u8 buf[5];
	int i, j;
	int ret = 0;
	int column = sizeof(flash_init_data[0]);
	int row = sizeof(flash_init_data)/column;
	
	DBG("row = %d \n", row);

	for(i = 0; i < row; i++)
	{
		/*W: 16 00 09 00 40 00 00*/	
		for(j = 0; j < column - 2; j++)
		{
			buf[j] = flash_init_data[i][j];
			//DBG("0x%x ", buf[j]);
		}
		ret = bq27425_write(g_client,0x00,buf,5);

		/*W: 16 64 49 00*/
		for(j = 0; j < 2; j++)
		{
			buf[j] = flash_init_data[i][j+5];
			//DBG("0x%x ", buf[j]);
		}
		ret = bq27425_write(g_client,0x64,buf,2);
		
		/*X: 20*/
		msleep(20);
		/*C: 16 66 00*/
		buf[0] = 0x00;
		ret = bq27425_read(g_client,0x66,buf,1);
	}
}

static void bq27425_execute_flash_code(void)
{
	u8 buf[2];
	/*W: 16 00 0F*/
	buf[0] = 0x0F;
	bq27425_write(g_client,0x00,buf,1);
	/*W: 16 64 0F 00*/
	buf[0] = 0x0F;
	buf[1] = 0x00;
	bq27425_write(g_client,0x64,buf,2);
	/*X: 4000*/
	msleep(4000);
}

static void bq27425_exit_rom_mode(void)
{
	struct bq27425_device_info *di;
	u8 buf[2];

	di = bq27425_di;
	if(g_bq27425_mode == BQ27425_NORMAL_MODE){
		/*W: AA 00 14 04*/
		buf[0] = 0x14;
		buf[1] = 0x04;
		bq27425_write(di->client,0x00,buf,2);
		/*W: AA 00 72 36*/
		buf[0] = 0x72;
		buf[1] = 0x36;
		bq27425_write(di->client,0x00,buf,2);
		/*W: AA 00 FF FF*/
		buf[0] = 0xFF;
		buf[1] = 0xFF;
		bq27425_write(di->client,0x00,buf,2);
		/*W: AA 00 FF FF*/
		buf[0] = 0xFF;
		buf[1] = 0xFF;
		bq27425_write(di->client,0x00,buf,2);
		/*X: 1000*/
		msleep(1000);
	}
}

void bq27425_soft_reset(void)
{
	int ret = 0;
	int value = 0;
	u8 buf[2];

	buf[0] = 0x42;						//soft reset
	buf[1] = 0x00;
	bq27425_write(g_client,0x00,buf,2);
	udelay(66);
}

void bq27425_sealed(void)
{
	int ret = 0;
	int value = 0;
	u8 buf[2];

	buf[0] = 0x20;						//seal
	buf[1] = 0x00;
	bq27425_write(g_client,0x00,buf,2);
	udelay(66);
	ret = bq27425_read(g_client,0x00,buf,2);
}

static void bq27425_update_firmware(void)
{
	bq27425_unseal_device();

	bq27425_verify_exist_firmware();
	bq27425_enter_rom_mode();
	bq27425_write_flash_code();
	bq27425_execute_flash_code();

	g_bq27425_mode = BQ27425_NORMAL_MODE;
	g_client->addr = 0x55;
	bq27425_soft_reset();
	bq27425_sealed();
}

/*M-MT:read flag itpor bit*/
int bq27425_read_flag_itpor(struct i2c_client *client)
{
	u8 buf[2] = {0};
	int flags = 0;
	int status = 0;
	int ret = 0;

	ret = bq27425_read(client,BQ27425_REG_FLAGS, buf, 2);
	if (ret < 0) {
		DBG("error reading flags\n");
		return ret;
	}

	flags = get_unaligned_le16(buf);

	DBG("Enter:%s %d--flags = 0x%x\n",__FUNCTION__,__LINE__,flags);

	if (flags & BQ27425_FLAG_ITPOR)
	{
		return 1;
	}

	return 0;
}

/*M-MT:read control status ss bit*/
int bq27425_read_control_status(struct i2c_client *client)
{
	int ret = 0;
	int dev_type = 0;
	int control_status = 0;
	u8 buf[2];

	buf[0] = 0x00;						//CONTROL_STATUS
	buf[1] = 0x00;
	bq27425_write(client,0x00,buf,2);
	udelay(66);
	ret = bq27425_read(client,0x00,buf,2);
	control_status = get_unaligned_le16(buf);
	DBG("control_status=0x%x \n",control_status);
	
	buf[0] = 0x01;						//CONTROL_STATUS
	buf[1] = 0x00;
	bq27425_write(client,0x00,buf,2);
	udelay(66);
	ret = bq27425_read(client,0x00,buf,2);
	dev_type = get_unaligned_le16(buf);
	DBG("dev_type = 0x%x \n",dev_type);

	if(control_status & BQ27425_CONTROL_STATUS_SS){
		return 1;
	}
	else{
		return 0;
	}
}

/*M-MT:setup discharge/charge current threshold.*/
int bq27425_write_current_threshold(struct i2c_client *client)
{
	int ret = 0;
	int dsg_current_threshold = 0;
	u8 buf[16];

	// 1. unseal bq27425.
	bq27425_unseal_device();

	// 2. write BlockDataControl command to enable block data flash control.
	buf[0] = 0x00;
	bq27425_write(client,0x61,buf,1);
	udelay(66);

	// 3. write subclass id.
	buf[0] = 0x51;
	bq27425_write(client,0x3E,buf,1);
	udelay(66);

	// 4. write subclass current offset.
	buf[0] = 0x00;
	bq27425_write(client,0x3F,buf,1);
	udelay(66);

	// 5. read old dsg current.
	ret = bq27425_read(client,0x40,buf,2);
	dsg_current_threshold = get_unaligned_le16(buf);
	DBG("dsg_current_threshold = 0x%x \n",dsg_current_threshold);
#if 0
	ret = bq27425_read(client,0x40,buf,16);
	{
		int i;
		for(i =0; i< 16; i++)
		{
			DBG("0x%x ",buf[i]);
		}
		DBG(" \n");
	}
#endif

	// 6. read old checksum.
	//ret = bq27425_read(client,0x60,buf,1);
	//DBG("checksum = 0x%x \n",buf[0]);
#if 0
	// 7. write new taper current.
	buf[0] = 0x00;
	buf[1] = 0xC8;
	bq27425_write(client,0x40,buf,2);
	udelay(66);
	ret = bq27425_read(client,0x40,buf,2);
	dsg_current_threshold = get_unaligned_le16(buf);
	DBG("dsg_current_threshold =0x%x \n",dsg_current_threshold);	
	// 8. write new checksum.
#endif
	bq27425_soft_reset();
	bq27425_sealed();
}

static int bq27425_battery_probe(struct i2c_client *client,
				 const struct i2c_device_id *id)
{
	struct bq27425_device_info *di;
	int retval = 0;
	struct bq27425_platform_data *pdata;
	
	DBG("**********  bq27425_battery_probe**************  \n");
	
	if (!i2c_check_functionality(client->adapter, I2C_FUNC_I2C)){
		client->addr = 0x0B;
		if (!i2c_check_functionality(client->adapter, I2C_FUNC_I2C)){
			return -ENODEV;
		}
		else{
			g_bq27425_mode = BQ27425_ROM_MODE;
		}
	}
	else{
		g_bq27425_mode = BQ27425_NORMAL_MODE;
	}
	DBG("+ g_bq27425_mode=%d \n", g_bq27425_mode);
	
	pdata = client->dev.platform_data;
	g_pdata = pdata;
	g_client = client;

	di = kzalloc(sizeof(*di), GFP_KERNEL);
	if (!di) {
		dev_err(&client->dev, "failed to allocate device info data\n");
		retval = -ENOMEM;
		goto batt_failed_2;
	}
	i2c_set_clientdata(client, di);
	di->dev = &client->dev;
	di->bat.name = "battery";
	di->client = client;
	/* 4 seconds between monotor runs interval */
	di->interval = msecs_to_jiffies(4 * 1000);
	
	di->bat_num = pdata->bat_num;
	di->dc_check_pin = pdata->dc_check_pin;
	di->bat_check_pin = pdata->bat_check_pin;
	di->wake_irq = pdata->low_power_pin;
	
	if (pdata->io_init)
		pdata->io_init();

	bq27425_di = di;

	if(g_bq27425_mode == BQ27425_NORMAL_MODE){
		if(bq27425_read_flag_itpor(client) && (!bq27425_read_control_status(client))){
			bq27425_update_firmware();
		}
		else{
			DBG("NOT need bq27425_update_firmware \n");
		}
	}
	else
	{
		bq27425_update_firmware();
	}
	DBG("- g_bq27425_mode=%d \n", g_bq27425_mode);
	
	//M-MT:setup discharge/charge current threshold. 
	//bq27425_write_current_threshold(client);
			
	bq27425_powersupply_init(di);
	
	retval = power_supply_register(&client->dev, &di->bat);
	if (retval) {
		dev_err(&client->dev, "failed to register battery\n");
		goto batt_failed_4;
	}

	INIT_DELAYED_WORK(&di->work, bq27425_battery_work);
	schedule_delayed_work(&di->work, di->interval);
	dev_info(&client->dev, "support ver. %s enabled\n", DRIVER_VERSION);

	// battery low irq
	if(pdata->low_power_pin != INVALID_GPIO)
	{
		di->wake_irq = gpio_to_irq(pdata->low_power_pin);
		retval = request_irq(di->wake_irq, bq27425_bat_wakeup, IRQF_TRIGGER_FALLING, "bq27425_battery", di);
		if (retval) {
			printk("failed to request low_power_pin irq\n");
			goto err_batirq_failed;
		}
		
		INIT_DELAYED_WORK(&di->wakeup_work, bq27425_battery_wake_work);
		enable_irq_wake(di->wake_irq);
	}

	return 0;

batt_failed_4:
	kfree(di);
batt_failed_2:

err_batirq_failed:
	gpio_free(pdata->bat_check_pin);

	return retval;
}

static int bq27425_battery_remove(struct i2c_client *client)
{
	struct bq27425_device_info *di = i2c_get_clientdata(client);

	power_supply_unregister(&di->bat);
	kfree(di->bat.name);
	kfree(di);
	return 0;
}

static const struct i2c_device_id bq27425_id[] = {
	{ "bq27425", 0 },
};

static struct i2c_driver bq27425_battery_driver = {
	.driver = {
		.name = "bq27425",
	},
	.probe = bq27425_battery_probe,
	.remove = bq27425_battery_remove,
	.id_table = bq27425_id,
};

static int __init bq27425_battery_init(void)
{
	int ret;
	
	struct proc_dir_entry * battery_proc_entry;
	
	ret = i2c_add_driver(&bq27425_battery_driver);
	if (ret)
		printk(KERN_ERR "Unable to register BQ27425 driver\n");
	
	battery_proc_entry = proc_create("driver/power",0777,NULL,&battery_proc_fops);

	return ret;
}

//module_init(bq27425_battery_init);
//fs_initcall_sync(bq27425_battery_init);

fs_initcall(bq27425_battery_init);
//arch_initcall(bq27425_battery_init);

static void __exit bq27425_battery_exit(void)
{
	i2c_del_driver(&bq27425_battery_driver);
}
module_exit(bq27425_battery_exit);

MODULE_AUTHOR("clb");
MODULE_DESCRIPTION("BQ27425 battery monitor driver");
MODULE_LICENSE("GPL");
